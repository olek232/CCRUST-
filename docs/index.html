<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CCRUST Speed Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      background: black;
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
      margin: 0;
    }
    input, button {
      font-size: 1.2em;
      margin: 12px;
      padding: 10px;
      width: 80%;
      max-width: 300px;
      border: none;
      border-radius: 6px;
    }
    button {
      background-color: #444;
      color: white;
      cursor: pointer;
    }
    #countdown {
      font-size: 2em;
      margin: 20px;
      color: yellow;
    }
    #message {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 1em;
      color: #fffc66;
      background: rgba(0,0,0,0.4);
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      display: none;
    }
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 500;
      display: none;
    }
    #leaderboard {
      display: none;
      margin-top: 40px;
    }
    #leaderboard ul {
      list-style: none;
      padding: 0;
    }
    #leaderboard li {
      background: #222;
      margin: 6px;
      padding: 8px;
      border-radius: 6px;
    }
    #poolInfo h2 {
      font-size: 2em;
      color: #00ffcc;
      margin-bottom: 10px;
    }
    #poolAmount {
      font-size: 1.5em;
      color: gold;
      font-weight: bold;
    }
    .adsbox {
      margin: 20px auto;
    }
    #timer {
      font-size: 1em;
      color: #ccc;
      margin-bottom: 10px;
    }
    #description {
      font-size: 1em;
      color: #ccc;
      max-width: 500px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h1 id="title">CCRUST Speed Test</h1>

  <!-- üìò Game instructions in English -->
  <p id="description">
    Enter your Lightning Address ‚ö° and click Play. When the screen turns green ‚Äî react as fast as you can!  
    If your time is under 300ms, you‚Äôll be entered into the Top 10 leaderboard.  
    Pool rewards are divided based on rank.
  </p>

  <input type="text" id="wallet" placeholder="Enter your Lightning address ‚ö°" />
  <button id="startBtn">Play</button>
  <button id="leaderBtn">üèÜ Leaderboard</button>
  <div id="countdown"></div>
  <div id="message">Click when the screen turns green</div>

  <!-- üì∫ Reklama A-ADS -->
  <div class="adsbox">
    <iframe data-aa='2402384' src='//ad.a-ads.com/2402384?size=300x250' style='width:300px; height:250px; border:0px; padding:0; overflow:hidden; background-color: transparent;'></iframe>
  </div>

  <div id="leaderboard">
    <!-- ‚è≥ Timer until leaderboard closes -->
    <div id="timer">End of leaderboard: loading...</div>

    <div id="poolInfo">
      <h2>üí∞ Pool</h2>
      <div id="poolAmount">20 sats</div>
      <p style="color:#aaa;">Pool will increase on time</p>
    </div>

    <h2>üèÖ Top 10 Results</h2>
    <ul id="results"><li>Loading...</li></ul>
    <button id="backBtn">‚¨ÖÔ∏è Back to game</button>
  </div>

  <div id="overlay"></div>

  <!-- ‚è±Ô∏è Timer script -->
  <script>
    function updateTimer() {
      const endTime = new Date("2025-08-11T20:00:00+02:00").getTime();
      const now = Date.now();
      const diff = endTime - now;

      if (diff <= 0) {
        document.getElementById("timer").textContent = "End of leaderboard reached";
        return;
      }

      const hours = Math.floor(diff / 1000 / 3600);
      const minutes = Math.floor((diff % (3600 * 1000)) / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);

      document.getElementById("timer").textContent = `End of leaderboard: ${hours}h ${minutes}m ${seconds}s`;
    }

    setInterval(updateTimer, 1000);
    updateTimer();
  </script>

  <!-- üöÄ Gameplay logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDmakxhD7bNdeZX69r7wcC8sNzy0uuWpwY",
      authDomain: "ccrustst.firebaseapp.com",
      projectId: "ccrustst"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.addEventListener("DOMContentLoaded", () => {
      const walletInput = document.getElementById("wallet");
      const startBtn = document.getElementById("startBtn");
      const countdown = document.getElementById("countdown");
      const message = document.getElementById("message");
      const overlay = document.getElementById("overlay");
      const title = document.getElementById("title");
      const leaderBtn = document.getElementById("leaderBtn");
      const leaderboard = document.getElementById("leaderboard");
      const results = document.getElementById("results");
      const backBtn = document.getElementById("backBtn");

      let isGreen = false;
      let startTime = null;
      let canClick = false;

      startBtn.onclick = () => {
        const wallet = walletInput.value.trim();
        if (!wallet) return alert("Please enter your Lightning address!");

        startBtn.disabled = true;
        walletInput.disabled = true;
        leaderBtn.disabled = true;
        countdown.textContent = "3";

        let counter = 3;
        const interval = setInterval(() => {
          counter--;
          countdown.textContent = counter > 0 ? counter : "";
          if (counter === 0) {
            clearInterval(interval);
            startBtn.style.display = "none";
            walletInput.style.display = "none";
            countdown.style.display = "none";
            title.style.display = "none";
            leaderBtn.style.display = "none";
            overlay.style.display = "block";
            startGame(wallet);
          }
        }, 1000);
      };

      function startGame(wallet) {
        document.body.style.background = "gray";
        message.style.display = "block";
        canClick = true;
        const delay = Math.random() * 5000 + 2000;
        setTimeout(() => {
          document.body.style.background = "green";
          isGreen = true;
          startTime = Date.now();
        }, delay);
      }

      overlay.onclick = async () => {
        if (!canClick) return;
        const wallet = walletInput.value.trim();
        if (!isGreen) {
          alert("Too early! You lost.");
          location.reload();
          return;
        }

        const reactionTime = Date.now() - startTime;
        alert(`Your time: ${reactionTime}ms`);

        if (reactionTime < 300) {
          try {
            await addDoc(collection(db, "wyniki"), {
              wallet,
              reactionTime,
              timestamp: new Date().toISOString()
            });
          } catch (err) {
            console.error("Firebase error:", err);
          }
        }
        } catch (err) {
          console.error("Error saving result:", err);
        }

        location.reload();
      };

      leaderBtn.onclick = async () => {
        title.style.display = "none";
        walletInput.style.display = "none";
        startBtn.style.display = "none";
        countdown.style.display = "none";
        leaderBtn.style.display = "none";
        leaderboard.style.display = "block";

        // üîí No Firestore reads here; placeholder for static top10.json loading
        try {
          const res = await fetch("top10.json");
          const data = await res.json();
          results.innerHTML = data.map((entry, i) => {
            const share = [35, 20, 10, 5, 5, 5, 5, 5, 5, 5][i] || 0;
            return `<li>#${i + 1} ‚ûú ${entry.wallet} ‚Äî <strong>${entry.reactionTime}ms</strong> <span style="float:right; color:lime;">${share}% pool</span></li>`;
          }).join("");
        } catch (err) {
          results.innerHTML = "<li>Error loading static leaderboard</li>";
        }
      };

      backBtn.onclick = () => location.reload();
    });
  </script>
</body>
</html>
